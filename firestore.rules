rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      // Temporarily allow specific email as admin for testing
      // TODO: Set proper custom claims via Firebase Admin SDK
      return isSignedIn() && (
             request.auth.token.role == 'admin' ||
             request.auth.token.email == 'smunley13@gmail.com'
      );
    }

    function getUserEmail() {
      return request.auth.token.email;
    }

    function isTeamOwner(teamId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/teams/$(teamId)) &&
             getUserEmail() in get(/databases/$(database)/documents/teams/$(teamId)).data.owners;
    }

    function isRosterOwner(leagueId, teamId) {
      return isTeamOwner(teamId);
    }

    function isRosterLocked(leagueId, teamId) {
      let roster = get(/databases/$(database)/documents/rosters/$(leagueId + '_' + teamId));
      return roster.data.status == 'adminLocked';
    }

    function isLeagueMember(leagueId) {
      // Check if user owns any team in this league
      return isSignedIn() && (
        isAdmin() ||
        exists(/databases/$(database)/documents/teams/$(request.auth.uid))
      );
    }

    // Leagues collection
    match /leagues/{leagueId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Teams collection
    match /teams/{teamId} {
      // Allow reading if signed in (query filtering happens client-side)
      allow read: if isSignedIn();
      // Allow admins full write access
      allow create, delete: if isAdmin();
      // Allow team owners to update their own team
      allow update: if isSignedIn() && (
        isAdmin() ||
        getUserEmail() in resource.data.owners
      );
    }

    // Players collection
    match /players/{playerId} {
      allow read: if isSignedIn();
      allow write: if isAdmin(); // Only admins can modify player data
      // Allow updating roster.teamId and roster.leagueId during draft
      allow update: if isSignedIn() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['roster']) &&
        request.resource.data.roster.diff(resource.data.roster).affectedKeys().hasOnly(['teamId', 'leagueId']);
    }

    // Projected Stats collection
    match /projectedStats/{fantraxId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Previous Season Stats collection
    match /previousStats/{fantraxId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Rosters collection
    match /rosters/{rosterId} {
      // rosterId format: {leagueId}_{teamId}
      // Allow all signed-in users to read rosters (they can view any team's roster)
      allow read: if isSignedIn();

      allow create: if isSignedIn() && (
        isTeamOwner(request.resource.data.teamId) ||
        isAdmin()
      );

      allow update: if isSignedIn() && (
        // Owners can update their own roster if not locked
        (isTeamOwner(resource.data.teamId) &&
         resource.data.status != 'adminLocked') ||
        // Admins can always update
        isAdmin()
      );

      allow delete: if isAdmin();
    }

    // User profiles (optional for future use)
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    // Watchlists collection (team-based, shared by all co-owners)
    match /watchlists/{watchlistId} {
      // Team owners can read their team's watchlist
      allow read: if isSignedIn() && isTeamOwner(resource.data.teamId);
      // Team owners can create/update their team's watchlist
      allow create, update: if isSignedIn() && isTeamOwner(request.resource.data.teamId);
      // Team owners can delete their team's watchlist
      allow delete: if isSignedIn() && isTeamOwner(resource.data.teamId);
    }

    // Drafts collection
    match /drafts/{draftId} {
      // All signed-in users can read drafts
      allow read: if isSignedIn();
      // Only admins can create/delete drafts
      allow create, delete: if isAdmin();
      // Team owners can update the draft when making picks
      allow update: if isSignedIn() && (isAdmin() || true);
    }

    // Backups collection
    match /backups/{backupId} {
      // Only admins can read/write backups
      allow read, write: if isAdmin();
    }

    // Rookie Draft Picks collection
    match /rookieDraftPicks/{pickId} {
      // All signed-in users can read rookie picks
      allow read: if isSignedIn();
      // Only admins can create/update/delete rookie picks
      allow write: if isAdmin();
    }

    // Draft Picks collection
    match /draftPicks/{pickId} {
      // All signed-in users can read draft picks
      allow read: if isSignedIn();
      // Only admins can create/update/delete draft picks
      allow write: if isAdmin();
    }
  }
}
